#!/bin/bash

echo "PyAnimats multi-seed simulation ($(date))"
echo "~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~"
echo "Rebuilding C++..."
make
echo "...finished."

param_file=$1
output_dir=$2
seed_start=$3
num_seeds=$4
shift 4

echo "Writing results to '$output_dir'."
echo ""

for ((seed=$seed_start; seed < $(($seed_start + $num_seeds)); seed++))
do
  # Get the output with the seed directory included.
  cur_output_dir="$output_dir/seed-$seed"
  log_file="$cur_output_dir/output.log"
  # Ensure the output directory exists.
  mkdir -p $cur_output_dir
  # Build the command.
  cmd="python -m pyanimats run $param_file $cur_output_dir/output.json -r $seed $@"
  # Record command.
  echo "Command:\n$cmd\n" > $logfile
  # Display command.
  echo "Executing command:"
  echo $cmd
  echo ""
  # Run it!
  unbuffer $cmd 2>&1 | tee $log_file && echo "[Seed $seed] Wrote results to '$cur_output_dir'." &
done
